- hosts: all
  roles:
    - common
- hosts: all:!packer
  vars:
    subdomain: "{{lookup('env', 'SUBDOMAIN')}}"
    domain: "{{lookup('env', 'DOMAIN')}}"
    full_domain: "{{(subdomain == '') | ternary(domain, '%s.%s' % (subdomain, domain))}}"
    env_file_path: "{{lookup('env', 'ENV_FILE_PATH')}}"
    env_file: "{{lookup('file', env_file_path).replace('\n', ' ')}}"
    env_file_hash: "{{env_file | hash('sha1')}}"
    last_env_file_hash: null
  tasks:
    - command: dokku domains:report default --domains-app-vhosts
      name: list dokku domains
      register: dokku_domains_report_result
      changed_when: false
      failed_when: dokku_domains_report_result.rc != 0 and (dokku_domains_report_result.rc != 1 or dokku_domains_report_result.stderr != "not deployed")
    - command: dokku domains:add default {{full_domain}}
      name: add dokku domain
      register: dokku_domains_add_result
      when: full_domain not in dokku_domains_report_result.stdout.split(' ')
      changed_when: dokku_domains_add_result is succeeded
    - include_role:
        name: dokku/config
      vars:
        value: DATABASE_URL={{lookup('env', 'DATABASE_URL')}}
    - include_role:
        name: dokku/config
      vars:
        value: "{{env_file}}"
      when: env_file_hash != last_env_file_hash
    - set_fact:
        last_env_file_hash: "{{env_file_hash}}"
